<!DOCTYPE html>
<html>
    <head>
        <title>Compiler</title>
    </head>
    <script src="https://unpkg.com/wabt"></script>
    <script>
        (async () => {
            const wabt = await WabtModule();

            const watSource = `
                (module
(import "env" "print_text" (func $print_text (param i32)))
(import "env" "print_real" (func $print_real (param f64)))
(import "env" "print_ints" (func $print_ints (param i32 i32)))

(func $print_int (param $n i64)
  (call $print_ints
    (i32.wrap_i64 (local.get $n))
    (i32.wrap_i64 (i64.shr_u (local.get $n) (i64.const 32)))))

(func $strlen (param $ptr i32) (result i32)
  (local $len i32)
  (local.set $len (i32.const 0))
  (block $exit
    (loop $loop
      (i32.load8_u (local.get $ptr))
        (br_if $exit (i32.eqz (i32.load8_u (local.get $ptr))))
        (local.set $ptr (i32.add (local.get $ptr) (i32.const 1)))
        (local.set $len (i32.add (local.get $len) (i32.const 1)))
        (br $loop)))
  (local.get $len))
(func $strcmp_eq (param $a i32) (param $b i32) (result i32)
  (local $charA i32)
  (local $charB i32)

  (block $not_equal
    (loop $loop
      (local.set $charA (i32.load8_u (local.get $a)))
      (local.set $charB (i32.load8_u (local.get $b)))

      (br_if $not_equal (i32.ne (local.get $charA) (local.get $charB)))
      (br_if 1 (i32.eqz (local.get $charA)))

      (local.set $a (i32.add (local.get $a) (i32.const 1)))
      (local.set $b (i32.add (local.get $b) (i32.const 1)))
      (br $loop))
    (i32.const 1)
    return)
  (i32.const 0))
(func $strcmp_lt (param $a i32) (param $b i32) (result i32)
  (local $charA i32)
  (local $charB i32)

  (block $gt_eq
    (loop $loop
      (local.set $charA (i32.load8_u (local.get $a)))
      (local.set $charB (i32.load8_u (local.get $b)))

      (br_if $gt_eq (i32.ge_u (local.get $charA) (local.get $charB)))
      (br_if 1 (i32.eqz (local.get $charA)))

      (local.set $a (i32.add (local.get $a) (i32.const 1)))
      (local.set $b (i32.add (local.get $b) (i32.const 1)))
      (br $loop))
    (i32.const 1)
    return)
  (i32.const 0))

(memory (export "memory") 1)
(global $heap_ptr (mut i32) (i32.const 0))
(func $malloc (param $size i32) (result i32)
    (local $old_base i32)
    (local $new_end i32)
    (local $need i32)

    (if (i32.eqz (local.get $size))
      (then
        (local.set $size (i32.const 1))))

    (local.set $size (i32.and (i32.add (local.get $size) (i32.const 7)) (i32.const -8)))

    (if (i32.eqz (global.get $heap_ptr))
      (then
        (global.set $heap_ptr (i32.shl (memory.size) (i32.const 16)))))

    (local.set $old_base (global.get $heap_ptr))
    (local.set $new_end (i32.add (local.get $old_base) (local.get $size)))
    (local.set $need (i32.shr_u (i32.add (local.get $new_end) (i32.const 65535)) (i32.const 16)))
    (local.set $need (i32.sub (local.get $need) (memory.size)))

    (if (i32.gt_s (local.get $need) (i32.const 0))
      (then
        (if (i32.eq (memory.grow (local.get $need)) (i32.const -1))
          (then
            (unreachable)))))

    (global.set $heap_ptr (local.get $new_end))
    (local.get $old_base))

  (func $strcat (param $a i32) (param $b i32) (result i32)
    (local $lenA i32)
    (local $lenB i32)
    (local $total i32)
    (local $dst i32)
    (local $i i32)

    (local.set $lenA (call $strlen (local.get $a)))
    (local.set $lenB (call $strlen (local.get $b)))
    (local.set $total (i32.add (i32.add (local.get $lenA) (local.get $lenB)) (i32.const 1)))
    (local.set $dst (call $malloc (local.get $total)))

    (local.set $i (i32.const 0))
    (block $copy_a_done
      (loop $copy_a
        (br_if $copy_a_done (i32.ge_u (local.get $i) (local.get $lenA)))
        (i32.store8
          (i32.add (local.get $dst) (local.get $i))
          (i32.load8_u (i32.add (local.get $a) (local.get $i))))
        (local.set $i (i32.add (local.get $i) (i32.const 1)))
        (br $copy_a)))

    (local.set $i (i32.const 0))
    (block $copy_b_done
      (loop $copy_b
        (br_if $copy_b_done (i32.ge_u (local.get $i) (local.get $lenB)))
        (i32.store8
          (i32.add (local.get $dst) (i32.add (local.get $lenA) (local.get $i)))
          (i32.load8_u (i32.add (local.get $b) (local.get $i))))
        (local.set $i (i32.add (local.get $i) (i32.const 1)))
        (br $copy_b)))

    (i32.store8
      (i32.add (local.get $dst) (i32.add (local.get $lenA) (local.get $lenB)))
      (i32.const 0))
    (local.get $dst))

(global $handy1 (mut i32) (i32.const 0))
(global $handy2 (mut i32) (i32.const 0))
(global $tmpf64 (mut f64) (f64.const 0.0))
(global $tmpi32 (mut i32) (i32.const 0))
(global $tmpi64 (mut i64) (i64.const 0))
(global $capture_ptr (mut i32) (i32.const 0))
(table $table 6 funcref)(func $func_0 (param i32) (result i64)(local i64)(local i64)(local i64)(local i32)(i64.const 0)(local.set 1)(i32.const -1)(drop)(local.get 0)(local.set 4)(i64.const 0)(local.set 2)(block $block_0 (loop $loop_0 (local.get 2)(local.get 4)(i64.load)(i64.lt_s)(br_if $block_0 (i32.eqz))(local.get 4)(local.get 2)(i32.add (i32.mul (i32.wrap_i64) (i32.const 8)) (i32.const 8))(i32.add)(i64.load)(local.set 3)(local.get 1)(local.get 3)(i64.add)(local.set 1)(i32.const -1)(local.get 2)(i64.const 1)(i64.add)(local.set 2)(br $loop_0)))(i32.const -1)(drop)(local.get 1))(elem (i32.const 0) $func_0)(func $func_1 (param i64) (result i32)(local i32)(local i64)(local i64)(local i32)(local.get 0)(global.set $handy2 (i32.wrap_i64))(global.set $handy1 (call $malloc (i32.add (i32.mul (global.get $handy2) (i32.const 8)) (i32.const 1))))(i64.store (global.get $handy1) (i64.extend_i32_s (global.get $handy2)))(global.get $handy1)(local.set 1)(i32.const -1)(drop)(local.get 1)(local.set 4)(i64.const 0)(local.set 2)(block $block_1 (loop $loop_1 (local.get 2)(local.get 4)(i64.load)(i64.lt_s)(br_if $block_1 (i32.eqz))(local.get 4)(local.get 2)(i32.add (i32.mul (i32.wrap_i64) (i32.const 8)) (i32.const 8))(i32.add)(i64.load)(local.set 3)(local.get 1)(local.get 2)(local.get 2)(i64.const 1)(i64.add)(global.set $tmpi64)(i32.add (i32.mul (i32.wrap_i64) (i32.const 8)) (i32.const 8))(i32.add)(global.get $tmpi64)(i64.store)(i32.const -1)(local.get 2)(i64.const 1)(i64.add)(local.set 2)(br $loop_1)))(i32.const -1)(drop)(local.get 1))(elem (i32.const 1) $func_1)(func $func_2 (param i64) (result i64)(local i64)(local i64)(i64.const 1)(local.set 1)(i32.const -1)(drop)(i64.const 1)(local.set 2)(i32.const -1)(drop)(block $block_2 (loop $loop_2 (local.get 0)(local.get 2)(i64.lt_s)(i32.eqz)(br_if $block_2 (i32.eqz))(local.get 1)(local.get 2)(i64.mul)(local.set 1)(i32.const -1)(drop)(local.get 2)(i64.const 1)(i64.add)(local.set 2)(i32.const -1)(drop)(br $loop_2)))(i32.const -1)(drop)(local.get 1))(elem (i32.const 2) $func_2)(func $func_3 (param f64) (result f64)(local.get 0)(local.get 0)(f64.add)(f64.const 3.142)(f64.add))(elem (i32.const 3) $func_3)(func $func_4 (result i32)(local i32)(local i64)(local i64)(local i32)(i64.const 5)(global.set $handy1 (call $malloc (i32.const 8)))(i32.store (global.get $handy1) (i32.const 2))(global.get $handy1)(global.set $handy1)(global.set $capture_ptr (i32.add (global.get $handy1) (i32.const 1)))(i32.load (global.get $handy1))(call_indirect (type $fn_type_0))(global.set $handy1 (call $malloc (i32.const 8)))(i32.store (global.get $handy1) (i32.const 1))(global.get $handy1)(global.set $handy1)(global.set $capture_ptr (i32.add (global.get $handy1) (i32.const 1)))(i32.load (global.get $handy1))(call_indirect (type $fn_type_1))(local.set 0)(i32.const -1)(drop)(local.get 0)(local.set 3)(i64.const 0)(local.set 1)(block $block_3 (loop $loop_3 (local.get 1)(local.get 3)(i64.load)(i64.lt_s)(br_if $block_3 (i32.eqz))(local.get 3)(local.get 1)(i32.add (i32.mul (i32.wrap_i64) (i32.const 8)) (i32.const 8))(i32.add)(i64.load)(local.set 2)(local.get 2)(call $print_int)(i32.const 0)(global.set $handy1 (call $malloc (i32.const 4)))(i32.store8 (i32.add (global.get $handy1) (i32.const 0)) (i32.const 32))(i32.store8 (i32.add (global.get $handy1) (i32.const 1)) (i32.const 0))(i32.store8 (i32.add (global.get $handy1) (i32.const 2)) (i32.const 0))(i32.store8 (i32.add (global.get $handy1) (i32.const 3)) (i32.const 0))(global.get $handy1)(call $print_text)(i32.const 0)(local.get 2)(global.set $handy1 (call $malloc (i32.const 8)))(i32.store (global.get $handy1) (i32.const 5))(global.get $handy1)(global.set $handy1)(global.set $capture_ptr (i32.add (global.get $handy1) (i32.const 1)))(i32.load (global.get $handy1))(call_indirect (type $fn_type_1))(call $print_int (i64.extend_i32_s))(i32.const 0)(global.set $handy1 (call $malloc (i32.const 4)))(i32.store8 (i32.add (global.get $handy1) (i32.const 0)) (i32.const 10))(i32.store8 (i32.add (global.get $handy1) (i32.const 1)) (i32.const 0))(i32.store8 (i32.add (global.get $handy1) (i32.const 2)) (i32.const 0))(i32.store8 (i32.add (global.get $handy1) (i32.const 3)) (i32.const 0))(global.get $handy1)(call $print_text)(i32.const 0)(local.get 1)(i64.const 1)(i64.add)(local.set 1)(br $loop_3)))(i32.const -1))(elem (i32.const 4) $func_4)(func $func_5 (param i64) (result i32)(local i32)(local i64)(i32.const 1)(local.set 1)(i32.const -1)(drop)(local.get 0)(i64.const 2)(i64.lt_s)(if (result i32)(then (i32.const 0)(local.set 1)(i32.const -1)(drop)(i32.const -1))(else (i64.const 2)(local.set 2)(i32.const -1)(drop)(block $block_4 (loop $loop_4 (local.get 0)(local.get 2)(local.get 2)(i64.mul)(i64.lt_s)(i32.eqz)(if (result i32)(then (local.get 1))(else (i32.const 0)))(br_if $block_4 (i32.eqz))(local.get 0)(local.get 2)(i64.rem_s)(i64.const 0)(i64.eq)(i32.eqz)(local.set 1)(i32.const -1)(drop)(local.get 2)(i64.const 1)(i64.add)(local.set 2)(i32.const -1)(drop)(br $loop_4)))(i32.const -1)(drop)(i32.const -1)))(drop)(local.get 1))(elem (i32.const 5) $func_5)(type $fn_type_1 (func (param i64) (result i32)))(type $fn_type_0 (func (param i64) (result i64)))(func (export "main") (call $func_4) (drop))) 

            `;

            // Compile WAT â†’ WASM binary
            const wasmModule = wabt.parseWat("example.wat", watSource);
            const { buffer } = wasmModule.toBinary({});

            let memory;

            function print_text(ptr) {
                const bytes = new Uint8Array(memory.buffer, ptr);
                for (let i = 0; bytes[i] !== 0; i++) {
                    if (bytes[i] === 10) {
                        document.write("<br>");
                    } else {
                        document.write(String.fromCharCode(bytes[i]));
                    }
                }
            }

            function print_real(num) {
                document.write(String(num));
            }

            function print_ints(low, high) {
                const big = BigInt(low >>> 0) | (BigInt(high) << 32n);
                document.write(big.toString());
            }

            const { instance } = await WebAssembly.instantiate(buffer, ({
                env: ({ print_text, print_real, print_ints, memory })
            }));

            let main = instance.exports.main;
            memory = instance.exports.memory;
            main()
        })();
    </script>

    <body>

    </body>
</html>